<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Code structure · EnergyModelsRecedingHorizon</title><meta name="title" content="Code structure · EnergyModelsRecedingHorizon"/><meta property="og:title" content="Code structure · EnergyModelsRecedingHorizon"/><meta property="twitter:title" content="Code structure · EnergyModelsRecedingHorizon"/><meta name="description" content="Documentation for EnergyModelsRecedingHorizon."/><meta property="og:description" content="Documentation for EnergyModelsRecedingHorizon."/><meta property="twitter:description" content="Documentation for EnergyModelsRecedingHorizon."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">EnergyModelsRecedingHorizon</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../manual/quick-start/">Quick Start</a></li><li><a class="tocitem" href="../../manual/philosophy/">Philosophy</a></li><li><a class="tocitem" href="../../manual/storage_end_value/">Storage end value</a></li><li><a class="tocitem" href="../../manual/simple-example/">Example</a></li><li><a class="tocitem" href="../../manual/NEWS/">Release notes</a></li></ul></li><li><span class="tocitem">How to</span><ul><li><a class="tocitem" href="../../how-to/adapt-emx-elem/">Adapt an EMX element</a></li><li><a class="tocitem" href="../../how-to/use-emrh/">Use the package</a></li></ul></li><li><span class="tocitem">Developer notes</span><ul><li class="is-active"><a class="tocitem" href>Code structure</a><ul class="internal"><li><a class="tocitem" href="#dev-code-gen"><span>General concept</span></a></li><li><a class="tocitem" href="#dev-code-res_type"><span>Implemented reset types</span></a></li><li><a class="tocitem" href="#dev-code-sub_type"><span>Implemented substitution types</span></a></li><li><a class="tocitem" href="#dev-code-int_flow"><span>Internal work flow</span></a></li></ul></li><li><a class="tocitem" href="../initialization/">Problem initialization</a></li><li><a class="tocitem" href="../future_value/">Future value implementation</a></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../library/public/">Public</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Internals</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../library/internals/types-EMRH/">Types</a></li><li><a class="tocitem" href="../../library/internals/methods-EMRH/">Methods - Internal</a></li><li><a class="tocitem" href="../../library/internals/methods-EMB/">Methods - <code>EnergyModelsBase</code></a></li><li><a class="tocitem" href="../../library/internals/reset/">Resetting functionality</a></li><li><a class="tocitem" href="../../library/internals/reference-EMGExt/">Internals - EnergyModelsGeography extension</a></li><li><a class="tocitem" href="../../library/internals/reference-POIExt/">Internals - ParametricOptInterface extension</a></li></ul></li></ul></li><li><a class="tocitem" href="../../references/">References</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Developer notes</a></li><li class="is-active"><a href>Code structure</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Code structure</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/EnergyModelsX/EnergyModelsRecedingHorizon.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/EnergyModelsX/EnergyModelsRecedingHorizon.jl/blob/main/docs/src/dev-notes/code-structure.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="dev-code"><a class="docs-heading-anchor" href="#dev-code">Code structure</a><a id="dev-code-1"></a><a class="docs-heading-anchor-permalink" href="#dev-code" title="Permalink"></a></h1><p><a href="../../library/internals/types-EMRH/#EnergyModelsRecedingHorizon.EnergyModelsRecedingHorizon"><code>EnergyModelsRecedingHorizon</code></a> is based on setting up optimization subproblems given implementation and optimization horizons. The horizons for the optimization subproblems are expressed through <a href="../../library/internals/types-EMRH/#EnergyModelsRecedingHorizon.AbstractHorizons"><code>AbstractHorizons</code></a> objects, see the <em><a href="../../manual/philosophy/#man-phil-hortyp">dedicated section on horizons</a></em>. These will ultimately define how many optimization subproblems will be solved and how large they will be.</p><h2 id="dev-code-gen"><a class="docs-heading-anchor" href="#dev-code-gen">General concept</a><a id="dev-code-gen-1"></a><a class="docs-heading-anchor-permalink" href="#dev-code-gen" title="Permalink"></a></h2><p>For every iteration over the horizons, the optimization subproblem needs to be updated for the time-dependent fields. This is done through <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractPath"><code>AbstractPath</code></a> objects, whose aim is to automatically identify the model variables that need updating. Each <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractPath"><code>AbstractPath</code></a> object corresponds to a field in the model structure to be updated. The creation of the accessors to these fields (known as <a href="https://juliaobjects.github.io/Accessors.jl/stable/lenses/">lenses</a>) is done through <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractReset"><code>AbstractReset</code></a> objects, allowing for type checking of the fields to be updated. This object must always be created through <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.ResetType"><code>ResetType</code></a> constructors. The element subject to updating is wrapped around an <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractSub"><code>AbstractSub</code></a> object, where the original (full-problem) and new (receding horizon) instances of the element are included as fields, as well as the <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractReset"><code>AbstractReset</code></a> objects linked to the element. A unified constructor, <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.Substitution"><code>Substitution</code></a>, is used within the model.</p><p>As a general rule, the fields that require updating are either related to the initial conditions of the system or to the time profiles that the system is subject to. For updating the time profiles, we read the originally provided time profile for the full optimization problem. As for the initial conditions of the system, each element is assumed to be independently initializable through their own variables. Initialization of the system is therefore done at the element level, which we describe in more detail in the <em><a href="../initialization/#dev-init">dedicated page on initialization</a></em>.</p><h2 id="dev-code-res_type"><a class="docs-heading-anchor" href="#dev-code-res_type">Implemented reset types</a><a id="dev-code-res_type-1"></a><a class="docs-heading-anchor-permalink" href="#dev-code-res_type" title="Permalink"></a></h2><p>The individual reset types correspond to fields of an element that should be replaced. The reset types have as individual fields</p><ul><li><strong><code>lens</code></strong> representing the lens pointing towards the field in the type,</li><li><strong><code>var</code></strong> corresponding to the parameter variable when using <code>ParametricOptInterface</code>, and</li><li><strong><code>val</code></strong> is the value which is used in the resets. Its meaning differs depending on the individual reset type.</li></ul><p><code>EnergyModelsRecedingHorizon</code> implements the following standard reset types:</p><ul><li><strong><code>OperReset</code></strong> with <code>OperPath</code>: A reset type pointing towards a field with <code>OperationalProfile</code>.<br/>The field <code>val</code> corresponds to the operational profile of the full time structure, <strong>not</strong> the profile of the individual horizon.</li><li><strong><code>ElementReset</code></strong> with <code>ElementPath</code>: A reset type pointing towards a field with an <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/case_element/#EnergyModelsBase.AbstractElement"><code>AbstractElement</code></a>.<br/>The field <code>val</code> corresponds to the instance of the element of the original case type.</li><li><strong><code>TimeWeightReset</code></strong> with <code>TimeWeightPath</code>: A reset type for a time weight of a <a href="../../library/public/#EnergyModelsRecedingHorizon.FutureValue"><code>FutureValue</code></a>.<br/>The field <code>val</code> is updated at the beginning of each iteration according to the optimization horizon end time.</li><li><strong><code>InitReset</code></strong> with <code>AbstractInitDataPath</code>: A reset type pointing towards fields of initial data.<br/>In addition, it has the <code>AbstractInitDataPath</code> instance as second field. The field <code>val</code> is updated after each optimization iteration with the extracted value from the optimization results.</li></ul><p>All reset types utilize an inner constructor for creating the lens in their construction. Furthermore, all reset types are constructed only through the function <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.ResetType"><code>EMRH.ResetType</code></a>.</p><div class="admonition is-success"><header class="admonition-header">New reset types</header><div class="admonition-body"><p>While the core structure includes the majority of the required reset types, it can be necessary to create new reset types. In this case, you must create:</p><ol><li>a subtype to <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractPath"><code>AbstractPath</code></a>,</li><li>a subtype to <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractReset"><code>EMRH.AbstractReset</code></a>,</li><li>a new method for the function <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.ResetType"><code>ResetType</code></a> using the same arguments order,</li><li>a new method for the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._find_update_paths-Tuple{T} where T&lt;:Union{AbstractElement, Resource, EnergyModelsRecedingHorizon.RecHorEnergyModel}"><code>EMRH._find_update_paths</code></a>, and</li><li>a new method for the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._reset_field-Tuple{Any, EnergyModelsRecedingHorizon.ElementReset, EnergyModelsRecedingHorizon.UpdateCase, Vector{&lt;:TimeStruct.TimePeriod}}"><code>EMRH._reset_field</code></a> and <em><a href="../../library/internals/reference-POIExt/#EnergyModelsRecedingHorizon._reset_field-Tuple{Any, Any, EnergyModelsRecedingHorizon.ElementReset, EnergyModelsRecedingHorizon.UpdateCase, TimeStructure}">its <code>POI</code> extension</a></em>.</li></ol><p>In general, it should not be necessary to create a new reset type as we simplified the approach for initialization data through the utilization of a parametric type.</p></div></div><h2 id="dev-code-sub_type"><a class="docs-heading-anchor" href="#dev-code-sub_type">Implemented substitution types</a><a id="dev-code-sub_type-1"></a><a class="docs-heading-anchor-permalink" href="#dev-code-sub_type" title="Permalink"></a></h2><p>Substitution types unify all resets within an <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/case_element/#EnergyModelsBase.AbstractElement"><code>AbstractElement</code></a>. All substitution types are parametric on the element type and have the fields</p><ul><li><strong><code>new</code></strong> representing the new element instance that is used in the case for analysis,</li><li><strong><code>org</code></strong> representing the original element instance from the original case structure, and</li><li><strong><code>resets::Vector{&lt;:AbstractReset}</code></strong> including all <code>AbstractReset</code>s that are relevant for the given type.</li></ul><p>They are constructed through the function <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.Substitution"><code>EMRH.Substitution</code></a>.</p><p><code>EnergyModelsRecHorizon</code> implements the following standard reset types:</p><ul><li><strong><code>ModelSub</code></strong> for resetting fields in the model type,</li><li><strong><code>ProductSub</code></strong> for resetting fields in <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/resources/#lib-pub-res"><code>Resource</code></a>s,</li><li><strong><code>NodeSub</code></strong> for resetting fields in <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/nodes/#lib-pub-nodes"><code>Node</code></a>,</li><li><strong><code>LinkSub</code></strong> for resetting fields in <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/links/#lib-pub-links"><code>Link</code></a>, and</li><li><strong><code>FutureValueSub</code></strong> for resetting fields in <a href="../../library/public/#EnergyModelsRecedingHorizon.FutureValue"><code>FutureValue</code></a>.</li></ul><p>The extension for <code>EnergyModelsGeography</code> adds the following additional reset types:</p><ul><li><strong><code>AreaSub</code></strong> for resetting fields in <a href="https://energymodelsx.github.io/EnergyModelsGeography.jl/stable/library/public/area/#lib-pub-area"><code>Area</code></a>s and</li><li><strong><code>TransmissionSub</code></strong> for resetting fields in <a href="https://energymodelsx.github.io/EnergyModelsGeography.jl/stable/library/public/transmission/#lib-pub-transmission"><code>Transmission</code></a> corridors.</li></ul><div class="admonition is-success"><header class="admonition-header">New `AbstractElement`s</header><div class="admonition-body"><p>If your <code>EnergyModelsBase</code> extension introduces new <code>AbstractElement</code>s, you must provide:</p><ol><li>a subtype to <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.AbstractSub"><code>EMRH.AbstractSub</code></a>,</li><li>a method to the function <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon._ele_to_sub"><code>EMRH._ele_to_sub</code></a>, and</li><li>a method for your function for extracting the <code>AbstractElement</code> from the <code>UpdateCase</code>, see, <em>e.g.</em>, <a href="../../library/internals/methods-EMB/#EnergyModelsBase.get_nodes"><code>EMB.get_nodes</code></a>.</li></ol><p>Depending on the structure of your <code>AbstractElement</code>, it can be furthermore necessary to provide new methods to the functions <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.original"><code>EMRH.original</code></a> and <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.updated"><code>EMRH.updated</code></a>.</p></div></div><h2 id="dev-code-int_flow"><a class="docs-heading-anchor" href="#dev-code-int_flow">Internal work flow</a><a id="dev-code-int_flow-1"></a><a class="docs-heading-anchor-permalink" href="#dev-code-int_flow" title="Permalink"></a></h2><p>While the internal work flow is in general the same whether you use <a href="https://jump.dev/ParametricOptInterface.jl/stable/"><code>ParametricOptInterface</code></a> or not, there are some differences in the individual function flow. The following section provides the general overview with differentiation between the individual implementations.</p><ol><li><p>The <a href="../../library/internals/reset/#EnergyModelsRecedingHorizon.UpdateCase"><code>UpdateCase</code></a> is first created for all elements through the functions <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._create_updatetype"><code>EMRH._create_updatetype</code></a> and <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._add_elements!"><code>EMRH._add_elements!</code></a>. These functions create the individual substitution and reset types including the relevant lenses. The functions are agnostic whether you use <code>ParametricOptInterface</code> or not.</p><div class="admonition is-info"><header class="admonition-header">POI implementation</header><div class="admonition-body"><p>The <code>POI</code> implementation requires as additional step the initialization of the <code>JuMP</code> model through calling the function <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/functions/#EnergyModelsBase.create_model"><code>create_model</code></a> to avoid constructing the model in every single iteration. To this end, the specific case and model are initialized through the function <a href="../../library/internals/reference-POIExt/#POIExt._init_update_case!"><code>POIExt._init_update_case!</code></a> in which the first horizon is used for the initialization of the optimization problem and the creation of the additional auxiliary variables required for the parameters.</p></div></div></li><li><p>The individual elements with <a href="../../library/public/#EnergyModelsRecedingHorizon.AbstractInitData"><code>AbstractInitData</code></a> are identified to avoid iterating through all elements in each iteration of the receding horizon framework. In addition, we rearrange the <a href="../../library/public/#EnergyModelsRecedingHorizon.FutureValue"><code>FutureValue</code></a> substitution types for simplified later updating.</p></li><li><p>The algorithm iterates through all horizons sequentially and solves the optimization problem.</p><ol><li><p>If the system includes <a href="../../library/public/#EnergyModelsRecedingHorizon.FutureValue"><code>FutureValue</code></a> types, we update <code>FutureValue</code>s whose weight is dependent on the elapsed time using the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._update_future_value!"><code>EMRH._update_future_value!</code></a>. This is for example the case for <a href="../../library/public/#EnergyModelsRecedingHorizon.StorageValueCuts"><code>StorageValueCuts</code></a>.</p></li><li><p>The second step is different in the two implementations.</p><div class="admonition is-success"><header class="admonition-header">Standard implementation</header><div class="admonition-body"><p>In the standard implementation, we first update the <code>UpdateCase</code> created in the first step through the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon._update_update_case!"><code>EMRH._update_update_case!</code></a> and subsequently extract from the <code>UpdateCase</code> both the <code>model</code> and <code>case</code> required for creating an EMX model. Subsequently, we create the <code>JuMP</code> model through calling the function <a href="https://energymodelsx.github.io/EnergyModelsBase.jl/stable/library/public/functions/#EnergyModelsBase.create_model"><code>create_model</code></a>.</p></div></div><div class="admonition is-info"><header class="admonition-header">POI implementation</header><div class="admonition-body"><p>In the <code>POI</code> implementation, we only have to update the values of the created parameter variables through the function <a href="../../library/internals/reference-POIExt/#POIExt.update_model!"><code>POIExt.update_model!</code></a>.</p></div></div><p>Subsequently, the model is optimized.</p></li><li><p>Once the model is solved, the operational results for the implementation horizon are extracted from the model and saved as a <code>DataFrame</code> through the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon.update_results!"><code>EMRH.update_results!</code></a>. Variables that are indexed with strategic periods are <strong>not</strong> extracted.</p></li><li><p>The value of the reset type for initialization data is updated using the results from the optimization problem using the function <a href="../../library/internals/methods-EMRH/#EnergyModelsRecedingHorizon.update_init_data!"><code>EMRH.update_init_data!</code></a>.</p></li></ol></li></ol></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../how-to/use-emrh/">« Use the package</a><a class="docs-footer-nextpage" href="../initialization/">Problem initialization »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.9.0 on <span class="colophon-date" title="Thursday 27 March 2025 11:22">Thursday 27 March 2025</span>. Using Julia version 1.11.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
